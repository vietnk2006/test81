<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>IELTS Listening ‚Äì Test 81</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{font-family:Arial,sans-serif;max-width:980px;margin:auto;padding:20px}
    h2{margin:0 0 6px}
    .note{font-weight:700;color:#b00000;margin:6px 0 18px}
    .timer{font-size:18px;font-weight:800;margin-bottom:12px}
    .card{border:1px solid #ddd;border-radius:12px;padding:15px;margin-bottom:18px}
    .imgwrap img{max-width:100%;border-radius:10px;border:1px solid #eee}
    .question{display:flex;align-items:center;margin:8px 0;gap:10px}
    .question label{width:70px;font-weight:700}
    input[type="text"]{width:100%;padding:8px;font-size:14px;text-transform:uppercase}
    button{padding:10px 15px;font-size:15px;cursor:pointer}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .ok{color:#0a7a0a;font-weight:800}
    .bad{color:#b00000;font-weight:800}
    .muted{color:#666;font-size:13px}

    /* Password overlay */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
    }
    .modal{
      width:min(420px, 92vw);
      background:#fff; border-radius:14px; padding:18px;
      border:1px solid #ddd;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .modal h3{margin:0 0 10px}
    .modal input{
      width:100%; padding:10px; font-size:15px;
      margin:8px 0 12px; border:1px solid #ccc; border-radius:10px;
    }
  </style>
</head>

<body>

<!-- üîí Password Gate -->
<div id="gate" class="overlay" style="display:none">
  <div class="modal">
    <h3>üîí Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ b·∫Øt ƒë·∫ßu</h3>
    <div class="muted">B·∫°n ph·∫£i nh·∫≠p ƒë√∫ng 1 trong c√°c m·∫≠t kh·∫©u ƒë∆∞·ª£c c·∫•p.</div>
    <input id="pw" type="password" placeholder="M·∫≠t kh·∫©u..." autocomplete="off">
    <div class="actions">
      <button type="button" onclick="unlock()">V√ÄO B√ÄI</button>
      <button type="button" onclick="location.reload()">T·∫¢I L·∫†I</button>
    </div>
    <div id="pwMsg" class="bad" style="margin-top:10px; display:none"></div>
  </div>
</div>

<h2>üéß IELTS LISTENING ‚Äì 40 QUESTIONS</h2>
<div class="note">[Please write your answers in ALL CAPITAL LETTERS for them to be counted.]</div>

<div class="card">
  <div class="muted">T√™n h·ªçc vi√™n (tu·ª≥ ch·ªçn)</div>
  <input id="studentName" type="text" placeholder="Nh·∫≠p t√™n..." style="margin-top:6px">
</div>

<div class="timer">‚è± Time left: <span id="time">40:00</span></div>

<div class="card">
  <h3 style="margin-top:0">üéß Listening Audio (kh√¥ng cho tua)</h3>
  <audio id="audio" controls style="width:100%" controlsList="nodownload noplaybackrate">
    <source src="assets/audio.mp3" type="audio/mpeg">
    Your browser does not support audio.
  </audio>
  <div class="muted" style="margin-top:8px">
    ‚ÄúKh√¥ng cho tua‚Äù l√† best-effort (ngƒÉn ng∆∞·ªùi d√πng b√¨nh th∆∞·ªùng). N·∫øu c·∫ßn kh√≥a tuy·ªát ƒë·ªëi, ph·∫£i d√πng backend.
  </div>
</div>

<div id="sections"></div>

<div class="card">
  <div class="actions">
    <button type="button" onclick="submitAndSave()">SUBMIT & SAVE TO GOOGLE SHEETS</button>
    <button type="button" onclick="downloadCSV()">DOWNLOAD CSV (m·ªü Excel)</button>
    <button type="button" onclick="clearAll()">CLEAR ALL</button>
  </div>
  <div id="status" class="muted" style="margin-top:10px"></div>
</div>

<script>
/* =========================
   1) GOOGLE SHEETS ENDPOINT
   ========================= */
// ‚úÖ D√ÅN LINK Web App Apps Script c·ªßa b·∫°n v√†o ƒë√¢y (k·∫øt th√∫c b·∫±ng /exec)
const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbwhBwmOxcGn4FuMBHrCgO1wYsSuo6GjsfXg8Mmr2mTB8btVKU8lXlYYiskVjzouA4y9hg/exec";

/* =========================
   2) 44 PASSWORDS
   ========================= */
const VALID_PASSWORDS = new Set([
  "2504887286",
  "2504887306",
  "2300110233",
  "2300110054",
  "2300109906",
  "2504887506",
  "2300110147",
  "2300110236",
  "2300110102",
  "2504887626",
  "2300110056",
  "2504887486",
  "2504887346",
  "2504887166",
  "2504887186",
  "2504887206",
  "2504887386",
  "2300110199",
  "2504887526",
  "2504887246",
  "2504887226",
  "2300110296",
  "2504887146",
  "2504887426",
  "2300110202",
  "2504887546",
  "2300110121",
  "2300110123",
  "2504887266",
  "2300110125",
  "2504887446",
  "2300109937",
  "2504887566",
  "2300110031",
  "2300110262",
  "2504887586",
  "2504887366",
  "2300110223",
  "2300110180",
  "2504887466",
  "2504887406",
  "2504887606",
  "2300110269",
  "2504887326"
]);

/* =========================
   3) CONFIG: images + time
   ========================= */
const IMAGE_PATHS = [
  "assets/img/1.png",
  "assets/img/2.png",
  "assets/img/3.png",
  "assets/img/4.png",
  "assets/img/5.png",
  "assets/img/6.png",
  "assets/img/7.png",
  "assets/img/8.png"
];

const QUESTIONS_PER_IMAGE = 5;
const TOTAL_IMAGES = 8;
const TOTAL_QUESTIONS = 40;
const TIME_LIMIT = 40 * 60; // seconds

/* =========================
   4) ANSWER KEY (40 answers)
   - Vi·∫øt HOA.
   - N·∫øu ƒë√°p √°n c√≥ kho·∫£ng tr·∫Øng/s·ªë (VD: "4.5 POUNDS"), ƒë·ªÉ ƒë√∫ng nh∆∞ v·∫≠y.
   ========================= */
const ANSWER_KEY = [
  // üîÅ THAY B·∫∞NG ƒê√ÅP √ÅN TH·∫¨T C·ª¶A B·∫†N (40 m·ª•c)
  "A","B","C","A","B",
  "A","B","C","A","B",
  "A","B","C","A","B",
  "A","B","C","A","B",
  "A","B","C","A","B",
  "A","B","C","A","B",
  "A","B","C","A","B",
  "A","B","C","A","B"
];

/* =========================
   5) PASSWORD GATE
   ========================= */
const gate = document.getElementById("gate");
let timerStarted = false;
let remaining = TIME_LIMIT;
let timerHandle = null;

function showGateIfLocked(){
  if (sessionStorage.getItem("unlocked") === "1") return;
  gate.style.display = "flex";
  document.body.style.overflow = "hidden";
}

function unlock(){
  const pw = (document.getElementById("pw").value || "").trim();
  const msg = document.getElementById("pwMsg");

  if (VALID_PASSWORDS.has(pw)) {
    sessionStorage.setItem("unlocked", "1");
    sessionStorage.setItem("used_password", pw);
    gate.style.display = "none";
    document.body.style.overflow = "auto";
    msg.style.display = "none";
    if (!timerStarted) startTimer();
  } else {
    msg.textContent = "Sai m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.";
    msg.style.display = "block";
  }
}

/* =========================
   6) BUILD UI (8 images, 40 questions)
   ========================= */
const container = document.getElementById("sections");
let q = 1;

for (let block = 0; block < TOTAL_IMAGES; block++) {
  const start = q;
  const end = q + QUESTIONS_PER_IMAGE - 1;

  const card = document.createElement("div");
  card.className = "card";

  const title = document.createElement("h3");
  title.style.marginTop = "0";
  title.textContent = `Questions ${start}‚Äì${end}`;
  card.appendChild(title);

  const imgWrap = document.createElement("div");
  imgWrap.className = "imgwrap";
  imgWrap.style.margin = "10px 0";

  const img = document.createElement("img");
  img.src = IMAGE_PATHS[block];
  img.alt = `Image for Questions ${start}-${end}`;
  imgWrap.appendChild(img);

  card.appendChild(imgWrap);

  for (let i = 0; i < QUESTIONS_PER_IMAGE; i++) {
    const row = document.createElement("div");
    row.className = "question";

    const label = document.createElement("label");
    label.textContent = `Q${q}:`;
    row.appendChild(label);

    const input = document.createElement("input");
    input.type = "text";
    input.required = true;
    input.placeholder = "TYPE ANSWER (CAPS)";
    input.addEventListener("input", () => {
      // ‚úÖ auto uppercase
      // ‚úÖ cho ph√©p: A-Z, 0-9, kho·∫£ng tr·∫Øng, ch·∫•m, g·∫°ch ngang, slash, d·∫•u nh√°y ƒë∆°n
      input.value = input.value
        .toUpperCase()
        .replace(/[^A-Z0-9 .\-\/']/g, "");
    });

    row.appendChild(input);
    card.appendChild(row);
    q++;
  }

  container.appendChild(card);
}

/* =========================
   7) TIMER (start after unlock)
   ========================= */
const timeEl = document.getElementById("time");

function tick(){
  const m = Math.floor(remaining / 60);
  const s = remaining % 60;
  timeEl.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;

  if (remaining <= 0) {
    submitAndSave(true);
    return;
  }
  remaining--;
  timerHandle = setTimeout(tick, 1000);
}

function startTimer(){
  timerStarted = true;
  tick();
}

/* =========================
   8) AUDIO NO-SEEK (best effort)
   ========================= */
const audio = document.getElementById("audio");
let lastGoodTime = 0;

audio.addEventListener("timeupdate", () => {
  if (!audio.seeking) lastGoodTime = audio.currentTime;
});

audio.addEventListener("seeking", () => {
  if (Math.abs(audio.currentTime - lastGoodTime) > 0.8) {
    audio.currentTime = lastGoodTime;
  }
});

/* =========================
   9) SCORING + SUBMIT TO GOOGLE
   ========================= */
function getAnswers(){
  const inputs = document.querySelectorAll("input[type='text']");
  return Array.from(inputs).map(i => (i.value || "").trim().toUpperCase());
}

function validateAnswers(ans){
  for (let i = 0; i < ans.length; i++){
    if (!ans[i]) return { ok:false, msg:`Please answer Question ${i+1}` };
  }
  return { ok:true };
}

function scoreAnswers(ans){
  const total = Math.min(ANSWER_KEY.length, ans.length);
  let score = 0;

  for (let i = 0; i < total; i++){
    const a = (ans[i] || "").trim().toUpperCase();
    const k = (ANSWER_KEY[i] || "").trim().toUpperCase();
    if (k && a === k) score++;
  }
  return { score, total };
}

async function postToGoogleSheets(payload){
  if (!ENDPOINT_URL || ENDPOINT_URL.includes("PASTE_YOUR_WEB_APP_URL_HERE")) {
    throw new Error("Ch∆∞a d√°n ENDPOINT_URL (Web App /exec).");
  }

  const res = await fetch(ENDPOINT_URL, {
    method: "POST",
    // text/plain gi√∫p tr√°nh m·ªôt s·ªë v·∫•n ƒë·ªÅ CORS/preflight
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  return data;
}

async function submitAndSave(auto=false){
  const status = document.getElementById("status");
  const name = (document.getElementById("studentName").value || "").trim();
  const usedPassword = sessionStorage.getItem("used_password") || "";
  const ans = getAnswers();

  const check = validateAnswers(ans);
  if (!check.ok){
    status.innerHTML = `<span class="bad">${check.msg}</span>`;
    return;
  }

  const local = scoreAnswers(ans);
  status.textContent = auto ? "Time up. Saving to Google Sheets..." : "Saving to Google Sheets...";

  const payload = {
    name,
    passwordUsed: usedPassword,
    answers: ans,
    clientScore: local.score,
    clientTotal: local.total,
    submittedAt: new Date().toISOString(),
    userAgent: navigator.userAgent
  };

  try {
    const out = await postToGoogleSheets(payload);
// ‚úÖ CHUY·ªÇN SANG TRANG HO√ÄN TH√ÄNH
sessionStorage.removeItem("unlocked");   // xo√° tr·∫°ng th√°i l√†m b√†i
sessionStorage.setItem("completed", "1"); // ƒë√°nh d·∫•u ƒë√£ xong

window.location.href = "done.html";
return;
;

    // N·∫øu server tr·∫£ score th√¨ ∆∞u ti√™n score server
    const score = (out.score ?? local.score);
    const total = (out.total ?? local.total);

    status.innerHTML = `<span class="ok">‚úÖ Saved to Google Sheets. Score: ${score}/${total}</span>`;
  } catch (e){
    status.innerHTML =
      `<span class="bad">‚ùå Save failed: ${e.message || e}</span><br>` +
      `<span class="muted">ƒêi·ªÉm (local): ${local.score}/${local.total}. B·∫°n v·∫´n c√≥ th·ªÉ t·∫£i CSV.</span>`;
  }
}

/* =========================
   10) DOWNLOAD CSV (Excel)
   ========================= */
function downloadCSV(){
  const status = document.getElementById("status");
  const name = (document.getElementById("studentName").value || "").trim();
  const usedPassword = sessionStorage.getItem("used_password") || "";
  const ans = getAnswers();

  const check = validateAnswers(ans);
  if (!check.ok){
    status.innerHTML = `<span class="bad">${check.msg}</span>`;
    return;
  }

  const res = scoreAnswers(ans);
  const ts = new Date().toISOString();

  const header = ["Timestamp","Name","PasswordUsed","Score","Total", ...Array.from({length:TOTAL_QUESTIONS},(_,i)=>`Q${i+1}`)];
  const row = [ts, name, usedPassword, res.score, res.total, ...ans];

  const esc = (v) => {
    const s = String(v ?? "");
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };

  const csv = header.map(esc).join(",") + "\n" + row.map(esc).join(",") + "\n";
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "listening_score.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  status.innerHTML = `<span class="ok">Downloaded CSV ‚úÖ</span>`;
}

/* =========================
   11) CLEAR
   ========================= */
function clearAll(){
  if (!confirm("Clear all answers?")) return;
  document.querySelectorAll("input[type='text']").forEach(i => i.value = "");
  document.getElementById("status").innerHTML = "";
}

/* =========================
   INIT
   ========================= */
// N·∫øu ƒë√£ ho√†n th√†nh th√¨ kh√¥ng cho v√†o l·∫°i
if (sessionStorage.getItem("completed") === "1") {
  window.location.href = "done.html";
} else {
  showGateIfLocked();
  if (sessionStorage.getItem("unlocked") === "1") startTimer();
}

</script>


</body>
</html>
