<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>IELTS Listening ‚Äì Test 81</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial,sans-serif;max-width:980px;margin:auto;padding:20px}
    .note{font-weight:700;color:#b00000;margin:6px 0 18px}
    .timer{font-size:18px;font-weight:800;margin-bottom:12px}
    .card{border:1px solid #ddd;border-radius:12px;padding:15px;margin-bottom:18px}
    .imgwrap img{max-width:100%;border-radius:10px;border:1px solid #eee}
    .question{display:flex;align-items:center;margin:8px 0;gap:10px}
    .question label{width:70px;font-weight:700}
    input[type="text"]{width:100%;padding:8px;text-transform:uppercase}
    button{padding:10px 15px;font-size:15px}
    .ok{color:#0a7a0a;font-weight:800}
    .bad{color:#b00000;font-weight:800}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:400px}
  </style>
</head>

<body>

<!-- PASSWORD -->
<div id="gate" class="overlay" style="display:none">
  <div class="modal">
    <h3>üîí Nh·∫≠p m·∫≠t kh·∫©u</h3>
    <input id="pw" type="password" placeholder="M·∫≠t kh·∫©u">
    <button onclick="unlock()">V√†o b√†i</button>
    <div id="pwMsg" class="bad"></div>
  </div>
</div>

<h2>üéß IELTS LISTENING ‚Äì 40 QUESTIONS</h2>
<div class="note">[Please write your answers in ALL CAPITAL LETTERS for them to be counted.]</div>

<div class="timer">‚è± Time left: <span id="time">40:00</span></div>

<div class="card">
  <audio id="audio" controls style="width:100%" controlsList="nodownload noplaybackrate">
    <source src="assets/audio.mp3" type="audio/mpeg">
  </audio>
</div>

<div id="questions"></div>

<div class="card">
  <button onclick="submitAndSave()">SUBMIT</button>
  <div id="status"></div>
</div>

<script>
/* ====== CONFIG ====== */
const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbwhBwmOxcGn4FuMBHrCgO1wYsSuo6GjsfXg8Mmr2mTB8btVKU8lXlYYiskVjzouA4y9hg/exec";

const VALID_PASSWORDS = new Set([
  "2504887286","2504887306","2300110233","2300110054","2300109906",
  "2504887506","2300110147","2300110236","2300110102","2504887626",
  "2300110056","2504887486","2504887346","2504887166","2504887186",
  "2504887206","2504887386","2300110199","2504887526","2504887246",
  "2504887226","2300110296","2504887146","2504887426","2300110202",
  "2504887546","2300110121","2300110123","2504887266","2300110125",
  "2504887446","2300109937","2504887566","2300110031","2300110262",
  "2504887586","2504887366","2300110223","2300110180","2504887466",
  "2504887406","2504887606","2300110269","2504887326"
]);

const ANSWER_KEY = [
  "A","B","C","A","B","A","B","C","A","B",
  "A","B","C","A","B","A","B","C","A","B",
  "A","B","C","A","B","A","B","C","A","B",
  "A","B","C","A","B","A","B","C","A","B"
];

/* ====== PASSWORD ====== */
function unlock(){
  const pw = document.getElementById("pw").value.trim();
  if (VALID_PASSWORDS.has(pw)){
    sessionStorage.setItem("unlocked","1");
    sessionStorage.setItem("password",pw);
    document.getElementById("gate").style.display="none";
    startTimer();
  } else {
    document.getElementById("pwMsg").textContent="Sai m·∫≠t kh·∫©u";
  }
}

/* ====== QUESTIONS ====== */
const qBox = document.getElementById("questions");
for(let i=1;i<=40;i++){
  qBox.innerHTML += `
  <div class="question">
    <label>Q${i}</label>
    <input type="text" id="q${i}">
  </div>`;
}

/* ====== TIMER ====== */
let time=40*60;
function startTimer(){
  setInterval(()=>{
    if(time<=0) submitAndSave(true);
    const m=Math.floor(time/60);
    const s=time%60;
    document.getElementById("time").textContent=
      String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
    time--;
  },1000);
}

/* ====== SUBMIT + REDIRECT ====== */
async function submitAndSave(auto=false){
  const ans=[];
  for(let i=1;i<=40;i++){
    ans.push(document.getElementById("q"+i).value.trim().toUpperCase());
  }

  const res = await fetch(ENDPOINT_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain"},
    body:JSON.stringify({
      answers:ans,
      passwordUsed:sessionStorage.getItem("password")
    })
  });

  const out = await res.json();
  if(out.ok){
    sessionStorage.setItem("completed","1");
    window.location.href="done.html";   // üî• C√ÅCH 2
  } else {
    document.getElementById("status").textContent=out.error;
  }
}

/* ====== INIT ====== */
if(sessionStorage.getItem("completed")==="1"){
  window.location.href="done.html";
} else {
  document.getElementById("gate").style.display="flex";
}
</script>

</body>
</html>
